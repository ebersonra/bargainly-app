<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metas e Or√ßamento - Barganha App</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1>Metas e Or√ßamento</h1>
            <p>Defina suas metas de gastos e acompanhe seu or√ßamento</p>
        </div>

        <div class="page-content">
            <div class="card">
                <div class="card-header">
                    <h2>Cadastrar Meta de Or√ßamento</h2>
                </div>
                <div class="card-body">
                    <form id="budgetForm">
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="budgetCategory">Categoria</label>
                                <select id="budgetCategory" name="category" required>
                                    <option value="">Selecione uma categoria</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="budgetLimit">Limite Mensal (R$)</label>
                                <input type="number" id="budgetLimit" name="limit" placeholder="Ex: 500.00" step="0.01" min="0" required>
                            </div>
                            <div class="input-group">
                                <label for="budgetMonth">M√™s de Refer√™ncia</label>
                                <input type="month" id="budgetMonth" name="month" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Cadastrar Meta</button>
                    </form>
                </div>
            </div>

            <div class="card mt-8">
                <div class="card-header">
                    <div class="flex justify-between items-center">
                        <h2>Minhas Metas</h2>
                        <button type="button" id="refreshBudgets" class="btn btn-secondary btn-sm">
                            üîÑ Atualizar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="budgetsList" class="space-y-4">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 11H7v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-9h-2v9H9v-9z"/>
                                <path d="M13 2.05v3.03c3.39.49 6 3.39 6 6.92 0 .9-.18 1.75-.48 2.54l.8 1.67c.67-1.25 1.01-2.65 1.01-4.21 0-4.39-3.21-8.06-7.33-8.95zM9.37 5.28C7.16 6.91 5.5 9.62 5.5 12.75c0 1.56.34 2.96 1.01 4.21l.8-1.67c-.3-.79-.48-1.64-.48-2.54 0-3.53 2.61-6.43 6-6.92V2.05c-4.12.89-7.33 4.56-7.33 8.95z"/>
                            </svg>
                            <h3>Nenhuma meta cadastrada</h3>
                            <p>Cadastre suas primeiras metas de or√ßamento</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget Summary -->
            <div class="card mt-8">
                <div class="card-header">
                    <h2>Resumo do M√™s</h2>
                </div>
                <div class="card-body">
                    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
                        <div class="stat-card">
                            <div class="stat-title">Total Or√ßado</div>
                            <div class="stat-value text-primary-600" id="totalBudget">R$ 0,00</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Total Gasto</div>
                            <div class="stat-value text-error-600" id="totalSpent">R$ 0,00</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Restante</div>
                            <div class="stat-value text-success-600" id="totalRemaining">R$ 0,00</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">% Utilizado</div>
                            <div class="stat-value" id="totalPercentage">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/src/utils/auth.js"></script>
    <script src="/src/utils/ui.js"></script>
    <script src="/src/utils/formatting.js"></script>

    <script>
        // Goals page specific controller
        class GoalsController {
            constructor() {
                this.init();
            }

            init() {
                this.setCurrentMonth();
                this.loadCategories();
                this.loadBudgets();
                this.setupEventListeners();
            }

            setCurrentMonth() {
                const now = new Date();
                const currentMonth = now.toISOString().slice(0, 7); // YYYY-MM format
                document.getElementById('budgetMonth').value = currentMonth;
            }

            async loadCategories() {
                try {
                    // Load categories for the select
                    if (typeof window !== 'undefined' && window.populatePurchaseCategorySelect) {
                        await window.populatePurchaseCategorySelect('budgetCategory');
                    }
                } catch (error) {
                    console.error('Erro ao carregar categorias:', error);
                }
            }

            setupEventListeners() {
                const form = document.getElementById('budgetForm');
                if (form) {
                    form.addEventListener('submit', (e) => this.handleFormSubmit(e));
                }

                document.getElementById('refreshBudgets')?.addEventListener('click', () => {
                    this.loadBudgets();
                });
            }

            async handleFormSubmit(e) {
                e.preventDefault();
                
                try {
                    const formData = new FormData(e.target);
                    const data = {
                        category: formData.get('category'),
                        limit: parseFloat(formData.get('limit')),
                        month: formData.get('month')
                    };

                    await this.createBudget(data);
                } catch (error) {
                    this.showError('Erro ao processar formul√°rio: ' + error.message);
                }
            }

            async createBudget(data) {
                try {
                    const userId = this.getUserId();
                    if (!userId) {
                        throw new Error('Usu√°rio n√£o autenticado');
                    }

                    const response = await fetch('/.netlify/functions/set-budget', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            category: data.category,
                            limit: data.limit,
                            month: data.month
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Erro ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    this.showSuccess('Meta cadastrada com sucesso!');
                    document.getElementById('budgetForm').reset();
                    this.setCurrentMonth();
                    await this.loadBudgets();
                } catch (error) {
                    throw new Error('Erro ao cadastrar meta: ' + error.message);
                }
            }

            async loadBudgets() {
                const container = document.getElementById('budgetsList');
                this.showLoading(container);

                try {
                    const userId = this.getUserId();
                    if (!userId) {
                        throw new Error('Usu√°rio n√£o autenticado');
                    }

                    const response = await fetch(`/.netlify/functions/get-budget-status?user_id=${userId}`);
                    if (!response.ok) {
                        throw new Error(`Erro ${response.status}: ${response.statusText}`);
                    }

                    const budgets = await response.json();
                    this.displayBudgets(budgets);
                    await this.updateBudgetSummary(budgets);
                } catch (error) {
                    this.showError('Erro ao carregar metas: ' + error.message);
                } finally {
                    this.hideLoading(container);
                }
            }

            displayBudgets(budgets) {
                const container = document.getElementById('budgetsList');
                
                if (!budgets || budgets.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 11H7v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-9h-2v9H9v-9z"/>
                                <path d="M13 2.05v3.03c3.39.49 6 3.39 6 6.92 0 .9-.18 1.75-.48 2.54l.8 1.67c.67-1.25 1.01-2.65 1.01-4.21 0-4.39-3.21-8.06-7.33-8.95zM9.37 5.28C7.16 6.91 5.5 9.62 5.5 12.75c0 1.56.34 2.96 1.01 4.21l.8-1.67c-.3-.79-.48-1.64-.48-2.54 0-3.53 2.61-6.43 6-6.92V2.05c-4.12.89-7.33 4.56-7.33 8.95z"/>
                            </svg>
                            <h3>Nenhuma meta cadastrada</h3>
                            <p>Cadastre suas primeiras metas de or√ßamento</p>
                        </div>
                    `;
                    return;
                }

                const budgetsHTML = budgets.map(budget => {
                    const percentage = budget.percentage || 0;
                    const progressClass = percentage > 100 ? 'danger' : percentage > 80 ? 'warning' : 'safe';
                    
                    return `
                        <div class="budget-item" data-budget="${budget.limit}" data-spent="${budget.spent}">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-semibold">${budget.category}</h3>
                                <span class="text-sm text-neutral-600">${this.formatCurrency(budget.spent)} / ${this.formatCurrency(budget.limit)}</span>
                            </div>
                            <div class="budget-progress">
                                <div class="budget-progress-bar ${progressClass}" style="width: ${Math.min(percentage, 100)}%"></div>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-neutral-600">${percentage.toFixed(1)}% utilizado</span>
                                <span class="text-neutral-600">Restante: ${this.formatCurrency(budget.remaining)}</span>
                            </div>
                            ${budget.alert ? `<div class="mt-2 text-sm text-error-600">‚ö†Ô∏è ${budget.alert}</div>` : ''}
                        </div>
                    `;
                }).join('');

                container.innerHTML = budgetsHTML;
            }

            async updateBudgetSummary(budgets) {
                try {
                    let totalBudget = 0;
                    let totalSpent = 0;

                    budgets.forEach(budget => {
                        totalBudget += budget.limit || 0;
                        totalSpent += budget.spent || 0;
                    });

                    const totalRemaining = totalBudget - totalSpent;
                    const totalPercentage = totalBudget > 0 ? (totalSpent / totalBudget * 100).toFixed(1) : 0;

                    // Update summary display
                    document.getElementById('totalBudget').textContent = this.formatCurrency(totalBudget);
                    document.getElementById('totalSpent').textContent = this.formatCurrency(totalSpent);
                    document.getElementById('totalRemaining').textContent = this.formatCurrency(totalRemaining);
                    document.getElementById('totalPercentage').textContent = totalPercentage + '%';

                    // Update percentage color
                    const percentageElement = document.getElementById('totalPercentage');
                    percentageElement.className = 'stat-value';
                    if (totalPercentage > 100) {
                        percentageElement.classList.add('text-error-600');
                    } else if (totalPercentage > 80) {
                        percentageElement.classList.add('text-warning-600');
                    } else {
                        percentageElement.classList.add('text-success-600');
                    }

                } catch (error) {
                    console.error('Erro ao atualizar resumo:', error);
                }
            }

            // Utility methods
            getUserId() {
                if (typeof window !== 'undefined' && window.getUserId) {
                    return window.getUserId();
                }
                
                // Fallback to cookie parsing
                const userCookie = document.cookie
                    .split('; ')
                    .find(row => row.startsWith('user_id='));
                return userCookie ? userCookie.split('=')[1] : null;
            }

            formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value || 0);
            }

            showLoading(container) {
                container.innerHTML = '<div class="loading">Carregando...</div>';
            }

            hideLoading(container) {
                // Loading is replaced by content
            }

            showSuccess(message) {
                if (typeof window !== 'undefined' && window.showNotification) {
                    window.showNotification(message, 'success');
                } else {
                    alert(message);
                }
            }

            showError(message) {
                if (typeof window !== 'undefined' && window.showNotification) {
                    window.showNotification(message, 'error');
                } else {
                    alert(message);
                }
                console.error(message);
            }
        }

        // Initialize goals controller when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new GoalsController();
        });
    </script>

    <style>
        .stat-card {
            background: var(--neutral-50);
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            text-align: center;
        }

        .stat-title {
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            color: var(--neutral-600);
            margin-bottom: var(--space-2);
        }

        .stat-value {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            color: var(--neutral-800);
        }

        .budget-item {
            background: var(--neutral-50);
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .budget-progress {
            background: var(--neutral-200);
            border-radius: var(--radius-full);
            height: 8px;
            overflow: hidden;
            margin: var(--space-2) 0;
        }

        .budget-progress-bar {
            height: 100%;
            transition: width var(--transition-base);
            border-radius: var(--radius-full);
        }

        .budget-progress-bar.safe {
            background: var(--success-500);
        }

        .budget-progress-bar.warning {
            background: var(--warning-500);
        }

        .budget-progress-bar.danger {
            background: var(--error-500);
        }
    </style>
</body>
</html>